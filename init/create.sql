CREATE TABLE Users (
    id INT GENERATED BY DEFAULT AS IDENTITY, 
    email VARCHAR UNIQUE NOT NULL, 
    hashed_password VARCHAR(255) NOT NULL,
    PRIMARY KEY(id)
);

CREATE TABLE Profile (
    uid INT REFERENCES Users(id),
    firstname VARCHAR(255) NOT NULL, 
    lastname VARCHAR(255) NOT NULL,
    description TEXT,
    PRIMARY KEY(uid)
);

CREATE TABLE Strategy (
    id INT GENERATED BY DEFAULT AS IDENTITY, 
    code TEXT NOT NULL,
    PRIMARY KEY(id)
);

CREATE TABLE UserStrategy (
    uid INT REFERENCES Users(id),
    strategy_id INT REFERENCES Strategy(id),
    PRIMARY KEY(strategy_id) 
);

CREATE TABLE Result (
    id INT GENERATED BY DEFAULT AS IDENTITY,
    PRIMARY KEY(id)
);

CREATE TABLE Backtest (
    id INT GENERATED BY DEFAULT AS IDENTITY, 
    result INT REFERENCES Result(id),
    code_snapshot TEXT NOT NULL, 
    test_start TIMESTAMP NOT NULL, 
    test_end TIMESTAMP NOT NULL, 
    created TIMESTAMP NOT NULL,
    PRIMARY KEY(id)
);

CREATE TABLE Competition (
    id INT GENERATED BY DEFAULT AS IDENTITY, 
    title VARCHAR(255) NOT NULL, 
    description TEXT NOT NULL, 
    owner INT REFERENCES Users(id),
    created TIMESTAMP NOT NULL, 
    end_time TIMESTAMP NOT NULL, 
    test_start TIMESTAMP NOT NULL, 
    test_end TIMESTAMP NOT NULL,
    PRIMARY KEY(id)
);

CREATE TABLE CompetitionEnrollment (
    comp_id INT REFERENCES Competition(id),
    uid INT REFERENCES Users(id),
    PRIMARY KEY(uid, comp_id)
);

CREATE TABLE CompetitionEntry (
    comp_id INT REFERENCES Competition(id),
    backtest_id INT REFERENCES Backtest(id),
    PRIMARY KEY(comp_id, backtest_id)
);

CREATE TABLE Symbol (
    symbol TEXT NOT NULL PRIMARY KEY, 
    name VARCHAR(255) NOT NULL,
    description TEXT NOT NULL
);

CREATE TABLE Quote (
    time TIMESTAMP NOT NULL, 
    symbol TEXT REFERENCES Symbol(symbol),
    price_open DOUBLE PRECISION NULL,
    price_high DOUBLE PRECISION NULL,
    price_low DOUBLE PRECISION NULL,
    price_close DOUBLE PRECISION NULL,

    PRIMARY KEY (symbol, time)
);

CREATE EXTENSION IF NOT EXISTS timescaledb;

/* Create hypertable from Quotes table */ 
SELECT create_hypertable('Quote', 'time');
